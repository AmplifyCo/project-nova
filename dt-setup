#!/bin/bash
# Digital Twin Setup - Complete automation
# ONE command to: install itself, dependencies, and configure everything
#
# Usage:
#   ./dt-setup              # First run from repo (self-installs)
#   dt-setup                # After install, run from anywhere

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIGURE_PY="$SCRIPT_DIR/configure.py"
REQUIREMENTS_TXT="$SCRIPT_DIR/requirements.txt"
INSTALL_DIR="/usr/local/bin"
COMMAND_NAME="dt-setup"

# Check if configure.py exists
if [ ! -f "$CONFIGURE_PY" ]; then
    echo "Error: configure.py not found at $CONFIGURE_PY"
    exit 1
fi

# ============================================
# Self-installation check
# ============================================
install_globally() {
    echo ""
    echo "üîß Installing dt-setup globally..."
    echo "   This allows you to run 'dt-setup' from anywhere (like git, python, npm)"
    echo ""

    # Make script executable
    chmod +x "$0"
    chmod +x "$CONFIGURE_PY"

    # Check if /usr/local/bin exists
    if [ ! -d "$INSTALL_DIR" ]; then
        echo "   Creating $INSTALL_DIR..."
        sudo mkdir -p "$INSTALL_DIR"
    fi

    # Copy script
    echo "   Copying to $INSTALL_DIR/$COMMAND_NAME"
    if sudo cp "$0" "$INSTALL_DIR/$COMMAND_NAME" && sudo chmod +x "$INSTALL_DIR/$COMMAND_NAME"; then
        echo ""
        echo "‚úÖ dt-setup installed successfully!"
        echo "   You can now run 'dt-setup' from any directory"
        echo ""
        return 0
    else
        echo ""
        echo "‚ùå Installation failed. Continuing with local setup..."
        echo ""
        return 1
    fi
}

# Check if running locally and not installed globally
if [[ "$0" == "./"* ]] || [[ "$0" == *"/dt-setup" && ! -f "$INSTALL_DIR/$COMMAND_NAME" ]]; then
    # Running from local directory and not installed globally
    if [[ "$1" != "--help" && "$1" != "-h" && "$1" != "help" && "$1" != "--skip-install" ]]; then
        echo ""
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "  Welcome to Digital Twin Setup!"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
        echo "First-time setup detected."
        echo ""

        read -p "Install dt-setup globally? (recommended) [Y/n]: " install_choice
        install_choice=${install_choice:-Y}

        if [[ "$install_choice" =~ ^[Yy]$ ]]; then
            install_globally
        else
            echo ""
            echo "‚è≠Ô∏è  Skipping global installation."
            echo "   You can install later with: make install"
            echo ""
        fi
    fi
fi

# ============================================
# Auto-install dependencies if needed
# ============================================
check_and_install_dependencies() {
    # Check if anthropic package is installed (key dependency)
    if ! python3 -c "import anthropic" 2>/dev/null; then
        echo ""
        echo "üì¶ Dependencies not found. Installing required packages..."
        echo ""

        # Check if requirements.txt exists
        if [ ! -f "$REQUIREMENTS_TXT" ]; then
            echo "‚ö†Ô∏è  Warning: requirements.txt not found at $REQUIREMENTS_TXT"
            echo "   Skipping dependency installation."
            echo ""
            return
        fi

        # Install dependencies
        echo "Running: pip install -r requirements.txt"
        echo ""

        if python3 -m pip install -r "$REQUIREMENTS_TXT"; then
            echo ""
            echo "‚úÖ Dependencies installed successfully!"
            echo ""
        else
            echo ""
            echo "‚ùå Failed to install dependencies."
            echo "   Please run manually: pip install -r requirements.txt"
            echo ""
            exit 1
        fi
    fi
}

# Check dependencies before running configuration (unless --help)
if [[ "$1" != "--help" && "$1" != "-h" && "$1" != "help" ]]; then
    check_and_install_dependencies
fi

# Parse arguments and map to configure.py flags
case "$1" in
    "")
        # No arguments - run full wizard
        python3 "$CONFIGURE_PY"
        ;;
    "digital-twin"|"all"|"full")
        # Full setup
        python3 "$CONFIGURE_PY"
        ;;
    "core"|"api"|"keys")
        # Core API keys
        python3 "$CONFIGURE_PY" --core-only
        ;;
    "telegram"|"tg")
        # Telegram bot
        python3 "$CONFIGURE_PY" --telegram-only
        ;;
    "email"|"mail")
        # Email configuration
        python3 "$CONFIGURE_PY" --email-only
        ;;
    "calendar"|"cal")
        # Calendar configuration
        python3 "$CONFIGURE_PY" --calendar-only
        ;;
    "--help"|"-h"|"help")
        # Show help
        cat << EOF
Digital Twin Setup - Complete Automation

ONE command does everything:
  1. ‚úÖ Installs itself globally (first run)
  2. ‚úÖ Installs Python dependencies
  3. ‚úÖ Runs interactive configuration
  4. ‚úÖ Auto-detects email providers
  5. ‚úÖ Updates .env file
  6. ‚úÖ Ready to run!

Usage:
  dt-setup                Full setup wizard (all tools)
  dt-setup core           Configure API keys only
  dt-setup telegram       Configure Telegram bot only
  dt-setup email          Configure email only
  dt-setup calendar       Configure calendar only

Aliases:
  digital-twin, all, full ‚Üí Full setup
  core, api, keys         ‚Üí Core API configuration
  telegram, tg            ‚Üí Telegram configuration
  email, mail             ‚Üí Email configuration
  calendar, cal           ‚Üí Calendar configuration

Examples:
  dt-setup                # Full wizard
  dt-setup email          # Just update email
  dt-setup core           # Just update API key

First-time setup (TWO commands!):
  git clone https://github.com/AmplifyCo/digital-twin.git
  cd digital-twin && ./dt-setup

  That's it! The script:
  ‚Ä¢ Installs itself globally
  ‚Ä¢ Installs all dependencies
  ‚Ä¢ Asks for Claude API key
  ‚Ä¢ Asks for Gmail credentials (optional)
  ‚Ä¢ Configures everything
  ‚Ä¢ Bot is ready to run!

After first run:
  dt-setup                # Works from anywhere (like git, python)

For advanced options:
  python3 configure.py --help

EOF
        ;;
    *)
        # Unknown argument - pass through to configure.py
        python3 "$CONFIGURE_PY" "$@"
        ;;
esac
