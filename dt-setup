#!/bin/bash
# Digital Twin Setup - Complete automation
# ONE command to: install Python, dependencies, configure, and run
#
# Usage:
#   ./dt-setup              # First run from repo (self-installs)
#   dt-setup                # After install, run from anywhere
#   dt-setup start          # Start the bot
#   dt-setup run            # Start the bot (alias)

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIGURE_PY="$SCRIPT_DIR/configure.py"
REQUIREMENTS_TXT="$SCRIPT_DIR/requirements.txt"
INSTALL_DIR="/usr/local/bin"
COMMAND_NAME="dt-setup"

# Check if configure.py exists
if [ ! -f "$CONFIGURE_PY" ]; then
    echo "Error: configure.py not found at $CONFIGURE_PY"
    exit 1
fi

# ============================================
# Check and install Python if needed
# ============================================
check_python() {
    if ! command -v python3 &> /dev/null; then
        echo ""
        echo "‚ùå Python 3 is not installed!"
        echo ""
        echo "Installing Python 3..."
        echo ""

        # Detect OS and install Python
        if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS
            if command -v brew &> /dev/null; then
                brew install python3
            else
                echo "Please install Homebrew first: https://brew.sh"
                echo "Then run: brew install python3"
                exit 1
            fi
        elif [[ -f /etc/os-release ]]; then
            . /etc/os-release
            if [[ "$ID" == "amzn" ]] || [[ "$ID_LIKE" == *"rhel"* ]]; then
                # Amazon Linux / RHEL-based
                sudo yum install python3 -y
            elif [[ "$ID" == "ubuntu" ]] || [[ "$ID" == "debian" ]] || [[ "$ID_LIKE" == *"debian"* ]]; then
                # Debian/Ubuntu
                sudo apt-get update && sudo apt-get install python3 python3-pip -y
            else
                echo "‚ö†Ô∏è  Unsupported Linux distribution: $ID"
                echo "   Please install Python 3 manually"
                exit 1
            fi
        else
            echo "‚ö†Ô∏è  Unsupported operating system"
            echo "   Please install Python 3 manually"
            exit 1
        fi

        # Verify installation
        if ! command -v python3 &> /dev/null; then
            echo "‚ùå Python 3 installation failed"
            exit 1
        fi

        echo "‚úÖ Python 3 installed successfully!"
    fi
}

# ============================================
# Check and install cloudflared if needed
# ============================================
check_and_install_cloudflared() {
    if ! command -v cloudflared &> /dev/null; then
        echo ""
        echo "üì¶ cloudflared not found. Installing Cloudflare Tunnel..."
        echo ""

        # Detect OS and install cloudflared
        if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS
            if command -v brew &> /dev/null; then
                brew install cloudflared
            else
                echo "‚ö†Ô∏è  Homebrew not found. Installing via download..."
                curl -L --output /usr/local/bin/cloudflared https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-darwin-amd64
                sudo chmod +x /usr/local/bin/cloudflared
            fi
        elif [[ -f /etc/os-release ]]; then
            . /etc/os-release
            if [[ "$ID" == "amzn" ]] || [[ "$ID_LIKE" == *"rhel"* ]]; then
                # Amazon Linux / RHEL-based
                wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.rpm
                sudo rpm -i cloudflared-linux-amd64.rpm
                rm -f cloudflared-linux-amd64.rpm
            elif [[ "$ID" == "ubuntu" ]] || [[ "$ID" == "debian" ]] || [[ "$ID_LIKE" == *"debian"* ]]; then
                # Debian/Ubuntu
                wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
                sudo dpkg -i cloudflared-linux-amd64.deb
                rm -f cloudflared-linux-amd64.deb
            else
                echo "‚ö†Ô∏è  Unsupported Linux distribution: $ID"
                echo "   Please install cloudflared manually: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/"
                return 1
            fi
        else
            echo "‚ö†Ô∏è  Unsupported operating system"
            echo "   Please install cloudflared manually: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/"
            return 1
        fi

        # Verify installation
        if ! command -v cloudflared &> /dev/null; then
            echo "‚ùå cloudflared installation failed"
            return 1
        fi

        echo "‚úÖ cloudflared installed successfully!"
    fi
    return 0
}

# ============================================
# Self-installation check
# ============================================
install_globally() {
    echo ""
    echo "üîß Installing dt-setup globally..."
    echo "   This allows you to run 'dt-setup' from anywhere (like git, python, npm)"
    echo ""

    # Make script executable
    chmod +x "$0"
    chmod +x "$CONFIGURE_PY"

    # Check if /usr/local/bin exists
    if [ ! -d "$INSTALL_DIR" ]; then
        echo "   Creating $INSTALL_DIR..."
        sudo mkdir -p "$INSTALL_DIR"
    fi

    # Copy script
    echo "   Copying to $INSTALL_DIR/$COMMAND_NAME"
    if sudo cp "$0" "$INSTALL_DIR/$COMMAND_NAME" && sudo chmod +x "$INSTALL_DIR/$COMMAND_NAME"; then
        echo ""
        echo "‚úÖ dt-setup installed successfully!"
        echo "   You can now run 'dt-setup' from any directory"
        echo ""
        return 0
    else
        echo ""
        echo "‚ùå Installation failed. Continuing with local setup..."
        echo ""
        return 1
    fi
}

# Check if running locally and not installed globally
if [[ "$0" == "./"* ]] || [[ "$0" == *"/dt-setup" && ! -f "$INSTALL_DIR/$COMMAND_NAME" ]]; then
    # Running from local directory and not installed globally
    if [[ "$1" != "--help" && "$1" != "-h" && "$1" != "help" && "$1" != "--skip-install" ]]; then
        echo ""
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "  Welcome to Digital Twin Setup!"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
        echo "First-time setup detected."
        echo ""

        read -p "Install dt-setup globally? (recommended) [Y/n]: " install_choice
        install_choice=${install_choice:-Y}

        if [[ "$install_choice" =~ ^[Yy]$ ]]; then
            install_globally
        else
            echo ""
            echo "‚è≠Ô∏è  Skipping global installation."
            echo "   You can install later with: make install"
            echo ""
        fi
    fi
fi

# ============================================
# Auto-install dependencies if needed
# ============================================
check_and_install_dependencies() {
    # Check if anthropic package is installed (key dependency)
    if ! python3 -c "import anthropic" 2>/dev/null; then
        echo ""
        echo "üì¶ Dependencies not found. Installing required packages..."
        echo ""

        # Check if requirements.txt exists
        if [ ! -f "$REQUIREMENTS_TXT" ]; then
            echo "‚ö†Ô∏è  Warning: requirements.txt not found at $REQUIREMENTS_TXT"
            echo "   Skipping dependency installation."
            echo ""
            return
        fi

        # Install dependencies
        echo "Running: pip install -r requirements.txt"
        echo ""

        if python3 -m pip install -r "$REQUIREMENTS_TXT"; then
            echo ""
            echo "‚úÖ Dependencies installed successfully!"
            echo ""
        else
            echo ""
            echo "‚ùå Failed to install dependencies."
            echo "   Please run manually: pip install -r requirements.txt"
            echo ""
            exit 1
        fi
    fi
}

# Check Python installation first (unless --help)
if [[ "$1" != "--help" && "$1" != "-h" && "$1" != "help" ]]; then
    check_python
fi

# Check dependencies before running configuration (unless --help or start/run)
if [[ "$1" != "--help" && "$1" != "-h" && "$1" != "help" && "$1" != "start" && "$1" != "run" ]]; then
    check_and_install_dependencies
fi

# ============================================
# Start bot helper
# ============================================
start_bot_if_requested() {
    # Only offer to start for full setup (not partial configs)
    if [[ "$1" == "" || "$1" == "digital-twin" || "$1" == "all" || "$1" == "full" ]]; then
        echo ""
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
        read -p "Start the bot now? [Y/n]: " start_choice
        start_choice=${start_choice:-Y}

        if [[ "$start_choice" =~ ^[Yy]$ ]]; then
            echo ""
            echo "üöÄ Starting Digital Twin bot..."
            echo ""

            # Check if we're in the right directory
            if [ -f "$SCRIPT_DIR/src/main.py" ]; then
                cd "$SCRIPT_DIR"
                python3 -m src.main
            else
                echo "‚ùå Error: src/main.py not found"
                echo "   Please run manually: python -m src.main"
            fi
        else
            echo ""
            echo "‚úÖ Setup complete!"
            echo ""
            echo "To start the bot later, run:"
            echo "  dt-setup start"
            echo ""
        fi
    fi
}

# Parse arguments and map to configure.py flags
case "$1" in
    "")
        # No arguments - run full wizard
        python3 "$CONFIGURE_PY"
        start_bot_if_requested ""
        ;;
    "digital-twin"|"all"|"full")
        # Full setup
        python3 "$CONFIGURE_PY"
        start_bot_if_requested "$1"
        ;;
    "core"|"api"|"keys")
        # Core API keys
        python3 "$CONFIGURE_PY" --core-only
        ;;
    "telegram"|"tg")
        # Telegram bot
        python3 "$CONFIGURE_PY" --telegram-only
        ;;
    "email"|"mail")
        # Email configuration
        python3 "$CONFIGURE_PY" --email-only
        ;;
    "calendar"|"cal")
        # Calendar configuration
        python3 "$CONFIGURE_PY" --calendar-only
        ;;
    "tunnel"|"cf"|"cloudflare")
        # Cloudflare Tunnel configuration
        python3 "$CONFIGURE_PY" --tunnel-only
        ;;
    "tunnel-start")
        # Start Cloudflare Tunnel
        echo ""
        echo "üåê Starting Cloudflare Tunnel..."
        echo ""

        # Check if cloudflared is installed
        if ! command -v cloudflared &> /dev/null; then
            echo "‚ö†Ô∏è  cloudflared not found. Installing..."
            check_and_install_cloudflared
        fi

        # Check if tunnel token is configured
        if [ -f "$SCRIPT_DIR/.env" ]; then
            TUNNEL_TOKEN=$(grep "^CLOUDFLARE_TUNNEL_TOKEN=" "$SCRIPT_DIR/.env" | cut -d'=' -f2)
            if [ -z "$TUNNEL_TOKEN" ]; then
                echo "‚ùå Tunnel token not found in .env file"
                echo "   Run: dt-setup tunnel"
                exit 1
            fi

            # Start tunnel
            echo "Starting tunnel in background..."
            nohup cloudflared tunnel --no-autoupdate run --token "$TUNNEL_TOKEN" > "$SCRIPT_DIR/logs/tunnel.log" 2>&1 &
            echo $! > "$SCRIPT_DIR/tunnel.pid"
            echo "‚úÖ Tunnel started (PID: $!)"
            echo "   Logs: $SCRIPT_DIR/logs/tunnel.log"
        else
            echo "‚ùå .env file not found"
            echo "   Run: dt-setup tunnel"
            exit 1
        fi
        echo ""
        ;;
    "tunnel-stop")
        # Stop Cloudflare Tunnel
        echo ""
        echo "üõë Stopping Cloudflare Tunnel..."
        echo ""

        if [ -f "$SCRIPT_DIR/tunnel.pid" ]; then
            PID=$(cat "$SCRIPT_DIR/tunnel.pid")
            if kill -0 "$PID" 2>/dev/null; then
                kill "$PID"
                rm -f "$SCRIPT_DIR/tunnel.pid"
                echo "‚úÖ Tunnel stopped (PID: $PID)"
            else
                echo "‚ö†Ô∏è  Tunnel process not found (stale PID)"
                rm -f "$SCRIPT_DIR/tunnel.pid"
            fi
        elif pgrep -f "cloudflared tunnel" > /dev/null; then
            pkill -f "cloudflared tunnel"
            echo "‚úÖ Tunnel stopped"
        else
            echo "‚ö†Ô∏è  Tunnel is not running"
        fi
        echo ""
        ;;
    "tunnel-status")
        # Check Cloudflare Tunnel status
        echo ""
        echo "üåê Cloudflare Tunnel Status"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""

        if [ -f "$SCRIPT_DIR/tunnel.pid" ]; then
            PID=$(cat "$SCRIPT_DIR/tunnel.pid")
            if kill -0 "$PID" 2>/dev/null; then
                echo "‚úÖ Status: Running (PID: $PID)"
                ps aux | grep "[c]loudflared"
            else
                echo "‚ùå Status: Not running (stale PID)"
                rm -f "$SCRIPT_DIR/tunnel.pid"
            fi
        elif pgrep -f "cloudflared tunnel" > /dev/null; then
            echo "‚úÖ Status: Running"
            ps aux | grep "[c]loudflared"
        else
            echo "‚ùå Status: Not running"
            echo ""
            echo "To start the tunnel:"
            echo "  dt-setup tunnel-start"
        fi
        echo ""
        ;;
    "start"|"run")
        # Start the bot
        echo ""
        echo "üöÄ Starting Digital Twin bot..."
        echo ""

        if [ -f "$SCRIPT_DIR/src/main.py" ]; then
            cd "$SCRIPT_DIR"
            python3 -m src.main
        else
            echo "‚ùå Error: src/main.py not found"
            echo "   Make sure you're in the digital-twin directory"
            exit 1
        fi
        ;;
    "stop")
        # Stop the bot
        echo ""
        echo "üõë Stopping Digital Twin bot..."
        echo ""

        # Try systemd first
        if systemctl is-active --quiet digital-twin 2>/dev/null; then
            sudo systemctl stop digital-twin
            echo "‚úÖ Bot stopped (systemd service)"
        elif pgrep -f "python.*src.main" > /dev/null; then
            # Kill Python process
            pkill -f "python.*src.main"
            echo "‚úÖ Bot stopped (process killed)"
        else
            echo "‚ö†Ô∏è  Bot is not running"
        fi
        echo ""
        ;;
    "restart")
        # Restart the bot
        echo ""
        echo "üîÑ Restarting Digital Twin bot..."
        echo ""

        # Try systemd first
        if systemctl is-enabled --quiet digital-twin 2>/dev/null; then
            sudo systemctl restart digital-twin
            echo "‚úÖ Bot restarted (systemd service)"
        else
            # Stop if running
            if pgrep -f "python.*src.main" > /dev/null; then
                pkill -f "python.*src.main"
                sleep 2
            fi

            # Start again
            if [ -f "$SCRIPT_DIR/src/main.py" ]; then
                cd "$SCRIPT_DIR"
                python3 -m src.main &
                echo "‚úÖ Bot restarted (background process)"
            else
                echo "‚ùå Error: src/main.py not found"
                exit 1
            fi
        fi
        echo ""
        ;;
    "status")
        # Check bot status
        echo ""
        echo "üìä Digital Twin Status"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""

        # Check systemd
        if systemctl is-active --quiet digital-twin 2>/dev/null; then
            echo "‚úÖ Status: Running (systemd service)"
            sudo systemctl status digital-twin --no-pager | head -15
        elif pgrep -f "python.*src.main" > /dev/null; then
            echo "‚úÖ Status: Running (process)"
            ps aux | grep "[p]ython.*src.main"
        else
            echo "‚ùå Status: Not running"
            echo ""
            echo "To start the bot:"
            echo "  dt-setup start"
        fi
        echo ""
        ;;
    "--help"|"-h"|"help")
        # Show help
        cat << EOF
Digital Twin Setup - Complete Automation

ONE command does everything:
  1. ‚úÖ Installs itself globally (first run)
  2. ‚úÖ Installs Python dependencies
  3. ‚úÖ Runs interactive configuration
  4. ‚úÖ Auto-detects email providers
  5. ‚úÖ Updates .env file
  6. ‚úÖ Ready to run!

Usage:
  dt-setup                Full setup wizard (all tools)

  Bot Management:
  dt-setup start          Start the bot
  dt-setup stop           Stop the bot
  dt-setup restart        Restart the bot
  dt-setup status         Check bot status

  Configuration:
  dt-setup core           Configure API keys only
  dt-setup telegram       Configure Telegram bot only
  dt-setup email          Configure email only
  dt-setup calendar       Configure calendar only
  dt-setup tunnel         Configure Cloudflare Tunnel only

  Tunnel Management:
  dt-setup tunnel-start   Start Cloudflare Tunnel
  dt-setup tunnel-stop    Stop Cloudflare Tunnel
  dt-setup tunnel-status  Check tunnel status

Aliases:
  digital-twin, all, full ‚Üí Full setup
  start, run              ‚Üí Start the bot
  core, api, keys         ‚Üí Core API configuration
  telegram, tg            ‚Üí Telegram configuration
  email, mail             ‚Üí Email configuration
  calendar, cal           ‚Üí Calendar configuration
  tunnel, cf, cloudflare  ‚Üí Cloudflare Tunnel configuration

Examples:
  dt-setup                # Full wizard
  dt-setup start          # Start the bot
  dt-setup stop           # Stop the bot
  dt-setup restart        # Restart the bot
  dt-setup status         # Check if running
  dt-setup email          # Update email settings
  dt-setup tunnel         # Configure Cloudflare Tunnel
  dt-setup tunnel-start   # Start tunnel
  dt-setup tunnel-stop    # Stop tunnel

First-time setup (TWO commands!):
  git clone https://github.com/AmplifyCo/digital-twin.git
  cd digital-twin && ./dt-setup

  That's it! The script:
  ‚Ä¢ Installs itself globally
  ‚Ä¢ Installs all dependencies
  ‚Ä¢ Asks for Claude API key
  ‚Ä¢ Asks for Gmail credentials (optional)
  ‚Ä¢ Configures everything
  ‚Ä¢ Offers to start the bot immediately
  ‚Ä¢ Bot is running!

After first run:
  dt-setup                # Works from anywhere (like git, python)

For advanced options:
  python3 configure.py --help

EOF
        ;;
    *)
        # Unknown argument - pass through to configure.py
        python3 "$CONFIGURE_PY" "$@"
        ;;
esac
